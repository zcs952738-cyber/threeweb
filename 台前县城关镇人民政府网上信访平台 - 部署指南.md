# 台前县城关镇人民政府网上信访平台 - 部署指南

## 项目概述

本项目是一个完整的网上信访平台，采用前后端分离架构：
- **前端**：React + Vite + TailwindCSS + shadcn/ui
- **后端**：Flask + SQLAlchemy + OpenAI API
- **数据库**：SQLite（可升级为MySQL/PostgreSQL）
- **AI服务**：OpenAI GPT-3.5-turbo

## 项目结构

```
/home/ubuntu/
├── petition-platform/          # React前端项目
│   ├── src/
│   │   ├── App.jsx            # 主应用组件
│   │   ├── components/        # 组件目录
│   │   │   ├── PetitionForm.jsx   # 信访提交表单
│   │   │   └── QueryForm.jsx      # 查询表单
│   │   └── App.css           # 样式文件
│   ├── dist/                 # 构建输出目录
│   └── package.json          # 依赖配置
├── petition-backend/          # Flask后端项目
│   ├── src/
│   │   ├── main.py           # Flask主应用
│   │   ├── models/           # 数据模型
│   │   │   ├── user.py       # 用户模型
│   │   │   └── petition.py   # 信访模型
│   │   ├── routes/           # API路由
│   │   │   ├── user.py       # 用户相关API
│   │   │   ├── petition.py   # 信访相关API
│   │   │   └── chatbot.py    # AI客服API
│   │   ├── static/           # 静态文件（包含前端构建文件）
│   │   └── database/         # 数据库文件
│   └── venv/                 # Python虚拟环境
├── system_test_report.md      # 系统测试报告
├── user_manual.md            # 用户使用手册
└── deployment_guide.md       # 本部署指南
```

## 核心功能

### 1. 信访提交系统
- 手机验证码登录
- 二级分类问题选择
- 完整表单填写和验证
- 查询码自动生成
- 数据库安全存储

### 2. 进度查询系统
- 查询码验证
- 信访详情展示
- 隐私信息脱敏
- 实时状态更新

### 3. AI智能客服
- OpenAI GPT集成
- 专业政策知识库
- 实际诉求解决
- 24小时在线服务

### 4. 管理功能
- 用户数据管理
- 信访记录管理
- 系统日志记录
- 安全访问控制

## 部署环境要求

### 服务器配置
- **操作系统**：Ubuntu 20.04+ / CentOS 7+
- **内存**：最低2GB，推荐4GB+
- **存储**：最低10GB，推荐20GB+
- **网络**：公网IP，开放80/443端口

### 软件依赖
- **Python**：3.8+
- **Node.js**：16+
- **Nginx**：1.18+（可选，用于反向代理）
- **SSL证书**：推荐使用HTTPS

## 部署步骤

### 1. 环境准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Python和Node.js
sudo apt install python3 python3-pip python3-venv nodejs npm -y

# 安装Nginx（可选）
sudo apt install nginx -y
```

### 2. 项目部署

```bash
# 克隆项目文件到服务器
scp -r petition-platform/ user@server:/var/www/
scp -r petition-backend/ user@server:/var/www/

# 进入后端目录
cd /var/www/petition-backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install flask flask-cors flask-sqlalchemy openai

# 设置环境变量
export OPENAI_API_KEY="your-openai-api-key"
export OPENAI_API_BASE="https://api.openai.com/v1"
```

### 3. 前端构建

```bash
# 进入前端目录
cd /var/www/petition-platform

# 安装依赖
npm install

# 构建生产版本
npm run build

# 复制构建文件到后端静态目录
cp -r dist/* /var/www/petition-backend/src/static/
```

### 4. 数据库初始化

```bash
# 进入后端目录
cd /var/www/petition-backend
source venv/bin/activate

# 启动应用（会自动创建数据库）
python src/main.py
```

### 5. 生产环境配置

#### 使用Gunicorn运行Flask应用

```bash
# 安装Gunicorn
pip install gunicorn

# 创建Gunicorn配置文件
cat > gunicorn.conf.py << EOF
bind = "0.0.0.0:5000"
workers = 4
worker_class = "sync"
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 100
EOF

# 启动应用
gunicorn -c gunicorn.conf.py src.main:app
```

#### Nginx反向代理配置

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location /static/ {
        alias /var/www/petition-backend/src/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 6. 系统服务配置

```bash
# 创建systemd服务文件
sudo cat > /etc/systemd/system/petition-platform.service << EOF
[Unit]
Description=Petition Platform
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/var/www/petition-backend
Environment=PATH=/var/www/petition-backend/venv/bin
Environment=OPENAI_API_KEY=your-openai-api-key
Environment=OPENAI_API_BASE=https://api.openai.com/v1
ExecStart=/var/www/petition-backend/venv/bin/gunicorn -c gunicorn.conf.py src.main:app
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable petition-platform
sudo systemctl start petition-platform
```

## 配置说明

### 环境变量
- `OPENAI_API_KEY`：OpenAI API密钥
- `OPENAI_API_BASE`：OpenAI API基础URL
- `FLASK_ENV`：Flask环境（production）
- `SECRET_KEY`：Flask密钥（建议更改）

### 数据库配置
- 默认使用SQLite，数据库文件位于 `src/database/app.db`
- 生产环境建议升级为MySQL或PostgreSQL
- 定期备份数据库文件

### 安全配置
- 更改Flask SECRET_KEY
- 配置防火墙规则
- 启用HTTPS
- 定期更新依赖包
- 配置访问日志

## 监控与维护

### 日志管理
```bash
# 查看应用日志
sudo journalctl -u petition-platform -f

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 性能监控
- 监控CPU和内存使用率
- 监控数据库大小和性能
- 监控API响应时间
- 监控AI服务调用次数

### 备份策略
```bash
# 数据库备份
cp /var/www/petition-backend/src/database/app.db /backup/app_$(date +%Y%m%d).db

# 完整项目备份
tar -czf /backup/petition-platform_$(date +%Y%m%d).tar.gz /var/www/petition-*
```

## 故障排除

### 常见问题

1. **AI客服无响应**
   - 检查OpenAI API密钥是否正确
   - 检查网络连接是否正常
   - 查看API调用日志

2. **数据库连接失败**
   - 检查数据库文件权限
   - 检查SQLAlchemy配置
   - 查看Flask应用日志

3. **前端页面无法访问**
   - 检查静态文件是否正确复制
   - 检查Nginx配置
   - 检查Flask路由配置

### 联系支持
如遇到技术问题，请联系：
- 技术支持：tech@taiqian.gov.cn
- 紧急联系：0393-1234569

---

**部署完成后，请访问服务器IP地址或域名测试所有功能是否正常工作。**

